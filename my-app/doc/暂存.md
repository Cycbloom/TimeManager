// NewNotebookInput.tsx
import { useState } from "react";
import { TextField, IconButton, InputAdornment } from "@mui/material";
import AddIcon from "@mui/icons-material/Add";

interface Props {
onCreate: (name: string) => void;
loading: boolean;
}

const NewNotebookInput = ({ onCreate, loading }: Props) => {
const [name, setName] = useState("");

const handleSubmit = () => {
if (name.trim()) {
onCreate(name);
setName("");
}
};

return (
<TextField
fullWidth
variant="outlined"
size="small"
label="新建笔记本"
value={name}
onChange={(e) => setName(e.target.value)}
onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
slotProps={{
        input: {
          endAdornment: (
            <InputAdornment position="end">
              <IconButton
                onClick={handleSubmit}
                disabled={!name || loading}
                edge="end"
              >
                <AddIcon fontSize="small" />
              </IconButton>
            </InputAdornment>
          ),
        },
      }}
/>
);
};

export default NewNotebookInput;

// NotebookListItem.tsx
import { useContext, useRef } from "react";
import {
ListItem,
ListItemButton,
ListItemText,
IconButton,
Box,
styled,
} from "@mui/material";
import DeleteIcon from "@mui/icons-material/Delete";
import { NoteFilterContext } from "./NoteFilterContext";
import { Notebook } from "../../hooks/useNotebooks";
import { DropTargetMonitor, useDrop } from "react-dnd";

interface Props {
notebook: Notebook;
onDelete: (id: number) => void;
onMoveNote: (noteId: number, targetNotebookId: number) => void;
loading: boolean;
}

interface DragItem {
id: number;
originNotebook: number;
}

const DropTargetBox = styled(Box)({
position: "relative",
"&::after": {
content: '""',
position: "absolute",
top: 0,
left: 0,
right: 0,
bottom: 0,
zIndex: 1,
},
});

const NotebookListItem = ({
notebook,
onDelete,
onMoveNote,
loading,
}: Props) => {
const { selectedNotebook, setSelectedNotebook } =
useContext(NoteFilterContext);

// 添加拖放目标功能
const [{ isOver, canDrop }, drop] = useDrop<
DragItem,
void,
{ isOver: boolean; canDrop: boolean }

> ({

    accept: "note",
    drop: (item) => {
      // 如果目标笔记本与原始笔记本不同，则执行移动
      if (item.originNotebook !== notebook.id) {
        onMoveNote(item.id, notebook.id);
      }
    },
    canDrop: (item) => item.originNotebook !== notebook.id,
    collect: (monitor: DropTargetMonitor<DragItem>) => ({
      isOver: !!monitor.isOver(),
      canDrop: !!monitor.canDrop(),
    }),

});

const handleDelete = () => {
if (window.confirm("删除笔记本会同时删除其中所有笔记，确定继续吗？")) {
onDelete(notebook.id);
}
};

const boxRef = useRef<HTMLDivElement>(null);
drop(boxRef);

return (
<DropTargetBox ref={boxRef}>
<ListItem
disablePadding
sx={{
          backgroundColor:
            isOver && canDrop ? "rgba(25, 118, 210, 0.08)" : "inherit",
          border: isOver && canDrop ? "2px dashed #1976d2" : "none",
          transition: "all 0.3s ease",
        }}
secondaryAction={
<IconButton edge="end" onClick={handleDelete} disabled={loading}>
<DeleteIcon fontSize="small" />
</IconButton>
} >
<ListItemButton
selected={selectedNotebook === notebook.id}
onClick={() => setSelectedNotebook(notebook.id)}
sx={{
            "&.Mui-selected": {
              backgroundColor: canDrop ? "rgba(25, 118, 210, 0.12)" : "inherit",
            },
          }} >
<ListItemText
primary={notebook.name}
secondary={
canDrop && isOver ? "松开以移动笔记到此笔记本" : undefined
}
slotProps={{
              primary: {
                fontWeight:
                  selectedNotebook === notebook.id ? "bold" : "normal",
                noWrap: true,
              },
              secondary: { color: "#1976d2", fontSize: "0.75rem" },
            }}
/>
</ListItemButton>
</ListItem>
</DropTargetBox>
);
};

export default NotebookListItem;

// src/components/NotebookSidebar.tsx
import { useContext, useState } from "react";
import {
List,
ListItem,
ListItemButton,
ListItemText,
Box,
Alert,
CircularProgress,
} from "@mui/material";
import { NoteFilterContext } from "./NoteFilterContext";
import useNotebooks from "../../hooks/useNotebooks";
import NewNotebookInput from "./NewNotebookInput";
import NotebookListItem from "./NotebookListItem";

const NotebookSidebar = () => {
const { selectedNotebook, setSelectedNotebook } =
useContext(NoteFilterContext);
const [newNotebookName, setNewNotebookName] = useState("");

// 获取笔记本列表
const {
notebooks,
loading,
error,
actions: { createNotebook, deleteNotebook, refreshNotebooks },
} = useNotebooks();

// 处理新建笔记本
const handleCreate = () => {
if (!newNotebookName.trim()) return;
createNotebook({ id: 0, name: newNotebookName });
setNewNotebookName("");
refreshNotebooks(); // 确保立即刷新列表
};

const handleDelete = (id: number) => {
deleteNotebook(id);
// 如果删除的是当前选中笔记本，重置选择
if (selectedNotebook === id) setSelectedNotebook(null);
};

return (
<Box sx={{ bgcolor: "background.paper" }}>
{/_ 新建笔记本区域 _/}
<Box p={2}>
<NewNotebookInput onCreate={handleCreate} loading={loading} />
</Box>
{/_ 状态指示 _/}
{error && <Alert severity="error">{error}</Alert>}
{loading && (
<Box display="flex" justifyContent="center" p={2}>
<CircularProgress size={24} />
</Box>
)}
{/_ 笔记本列表 _/}
<List dense>
<ListItem disablePadding>
<ListItemButton
selected={!selectedNotebook}
onClick={() => setSelectedNotebook(null)} >
<ListItemText
primary="全部笔记"
slotProps={{
                primary: {
                  fontWeight: selectedNotebook ? "normal" : "bold",
                },
              }}
/>
</ListItemButton>
</ListItem>

        {notebooks?.map((notebook) => (
          <NotebookListItem
            key={notebook.id}
            notebook={notebook}
            onDelete={handleDelete}
            loading={loading}
            onMoveNote={(nodeId, targetNotebookId) => {
              console.log(nodeId, targetNotebookId);
            }}
          />
        ))}
      </List>
    </Box>

);
};

export default NotebookSidebar;

import { createContext, useState } from "react";
import { HTML5Backend } from "react-dnd-html5-backend";
import { DndProvider } from "react-dnd";

import { NoteType } from "./BaseNoteForm";

export interface Tag {
id: number;
name: string;
}

interface NoteFilterContextType {
selectedType: NoteType | null;
selectedTags: Tag[];
tagsDirty: number;
selectedNotebook: number | null;
setSelectedType: (type: NoteType | null) => void;
setSelectedTags: (tags: Tag[]) => void;
setTagsDirty: () => void; // 外部调用时不需要参数
setSelectedNotebook: (notebookId: number | null) => void;
}

export const NoteFilterContext = createContext<NoteFilterContextType>({
selectedType: null,
selectedTags: [],
tagsDirty: 0, // 初始化计数器为 0
selectedNotebook: null,
setSelectedType: () => {},
setSelectedTags: () => {},
setTagsDirty: () => {}, // 外部调用时不需要参数
setSelectedNotebook: () => {},
});

export const NoteFilterProvider: React.FC<{ children: React.ReactNode }> = ({
children,
}) => {
// 定义状态
const [selectedType, setSelectedType] = useState<NoteType | null>(null);
const [selectedTags, setSelectedTags] = useState<Tag[]>([]);
const [tagsDirty, setTagsDirtyInternal] = useState(0); // 内部使用计数器
const [selectedNotebook, setSelectedNotebook] = useState<number | null>(null);

// 对外暴露的 setTagsDirty 方法，不需要参数，内部默认加一
const setTagsDirty = () => {
setTagsDirtyInternal((prev) => prev + 1);
};

return (
<DndProvider backend={HTML5Backend}>
<NoteFilterContext.Provider
value={{
          selectedType,
          selectedTags,
          tagsDirty, // 暴露计数器
          selectedNotebook,
          setSelectedType,
          setSelectedTags,
          setTagsDirty, // 暴露无需参数的方法
          setSelectedNotebook,
        }} >
{children}
</NoteFilterContext.Provider>
</DndProvider>
);
};

import { ListItem, ListItemText, IconButton, Box } from "@mui/material";
import EditIcon from "@mui/icons-material/Edit";
import DeleteIcon from "@mui/icons-material/Delete";
import { Note } from "../../hooks/useNote";
import { useDrag } from "react-dnd";
import { useRef } from "react";

interface Props {
note: Note;
onEdit: (note: Note) => void;
onDelete: (noteId: number) => void;
}

const NoteItem = ({ note, onEdit, onDelete }: Props) => {
// 添加拖拽功能
const [{ isDragging }, drag] = useDrag(() => ({
type: "note",
item: { id: note.id, originNotebook: note.notebook_id },
collect: (monitor) => ({
isDragging: !!monitor.isDragging(),
}),
}));

// 使用双重类型断言解决方案
const boxRef = useRef<HTMLDivElement>(null);
drag(boxRef.current);

return (
<Box
ref={boxRef as React.RefObject<HTMLDivElement>}
sx={{
        cursor: "move",
        "&:hover": {
          boxShadow: 1,
        },
      }} >
<ListItem
sx={{
          opacity: isDragging ? 0.5 : 1,
          transition: "opacity 0.3s ease",
          backgroundColor: isDragging ? "#fafafa" : "inherit",
        }}
secondaryAction={
<>
<IconButton
edge="end"
aria-label="edit"
onClick={() => onEdit(note)} >
<EditIcon />
</IconButton>
<IconButton
edge="end"
aria-label="delete"
onClick={() => onDelete(note.id)} >
<DeleteIcon />
</IconButton>
</>
} >
<ListItemText primary={note.title} secondary={note.content} />
</ListItem>
</Box>
);
};

export default NoteItem;
